<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/core.css">
    <script src="https://code.jquery.com/jquery-4.0.0.min.js" integrity="sha256-OaVG6prZf4v69dPg6PhVattBXkcOWQB62pdZ3ORyrao=" crossorigin="anonymous"></script>

    <title>Shopping Bag</title>
    <link rel="stylesheet" href="styles/cart.css">
</head>
<body>
    <header></header>

    <main>
        <div class="cc-product-list">
        </div>
        <div class="cc-cart-summary">
            <div class="cc-price-summary">
                <div>
                    <p>Totale carrello</p>
                    <p id="cart-total" class="cc-price-tag"></p>
                </div>

                <div>
                    <p>Spedizione</p>
                    <p id="shipping-total" class="cc-price-tag"></p>
                </div>

                <div>
                    <p>Totale</p>
                    <p id="payment-total" class="cc-price-tag"></p>
                </div>
            </div>

            <div class="cc-payment-options">
                <button id="payment-button"></button>
                <p>Oppure paga con</p>
                <div>
                    <button style="background-color: #222d65; color: #eeeeee;">PayPal</button>
                    <button style="background-color: #ffa8cd; color: #0b051d;">Klarna</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
    </footer>
    
    <script>
        /**
         * @param {{id: number, name: string, price: number}[]} products
         * @param {{id: number, count: number}[]} cart
         */
        function renderCartList(products, cart) {
            $("div.cc-product-list").empty();
            cart.forEach(cartItem => {
                const product = products.find(p => p.id == cartItem.id);
                $("div.cc-product-list").append(`
                    <div data-product-id="${product.id}">
                        <img src="./cdn/images/product-${product.id}.png"/>
                        <div>
                            <h2>${product.name}</h2>
                            <p><span class="cc-price-tag">${product.price}</span> /pc</p>
                            <div>
                                <button>&lt;</button>
                                <p>${cartItem.count}</p>
                                <button>&gt;</button>   
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        /**
         * @param {{id: number, name: string, price: number}[]} products
         * @param {{id: number, count: number}[]} cart
         */
        function renderCartSummary(products, cart) {
            const shippingPrice = 2.49;
            
            const cartTotal = cart
                .map(cartItem => {
                    const product = products.find(p => p.id == cartItem.id);
                    return product.price * cartItem.count
                })
                .reduce((cartTotal, totalProductCost) => cartTotal += totalProductCost, 0);


            $("#cart-total").text(cartTotal);
            $("#shipping-total").text(shippingPrice);
            $("#payment-total").text((cartTotal + shippingPrice).toFixed(2));
            $("#payment-button").text((cartTotal + shippingPrice).toFixed(2) + "â‚¬ - Procedi all'acquisto");
        }

        /**
         * @param {{id: number, name: string, price: number}[]} products
         * @param {{id: number, count: number}[]} cart
         */
        function renderCart(products, cart) {
            renderCartList(products, cart);
            renderCartSummary(products, cart);
        }

        /**
         *@returns {{id: number, name: string, price: number}[]}
         */
        async function getAllProducts() {
            const response = await fetch("./api/product");
            if (response.status !== 200) {
                console.error("Cannot fetch product data. Status ", response.status);
                return [];
            }
            return await response.json();
        }

        /**
         *@returns {{id: number, count: number}[]}
         */
        function loadCartFromLocalStorage() {
            const cartData = window.localStorage.getItem("cart");
            if (cartData === null) return [];
            return JSON.parse(cartData);
        }

        function onBuyButtonPressed() {
            const cart = loadCartFromLocalStorage();
            cart.forEach(async cartItem => {
                const response = fetch("./api/order",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "user_id": 2,
                            "product_id": cartItem.id,
                            "count": cartItem.count
                        })
                    }
                );
            })
        }

        $(async function() {
            const products = await getAllProducts();
            const cart = loadCartFromLocalStorage();
            renderCart(products, cart);

            $("#payment-button").on("click", onBuyButtonPressed);
        });
    </script>
</body>
</html>